name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Go API Gateway Tests
  api-gateway:
    name: API Gateway (Go)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/api-gateway
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      
      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-
      
      - name: Install dependencies
        run: go mod download
      
      - name: Run linter
        run: go vet ./...
      
      - name: Run tests
        run: go test -v -race -coverprofile=coverage.out ./...
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./apps/api-gateway/coverage.out
          flags: api-gateway

  # Rust Ingestion Worker Tests
  ingestion-worker:
    name: Ingestion Worker (Rust)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/ingestion-worker
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          components: rustfmt, clippy
      
      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Cache cargo index
        uses: actions/cache@v3
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Cache target directory
        uses: actions/cache@v3
        with:
          path: services/ingestion-worker/target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Run formatter check
        run: cargo fmt -- --check
      
      - name: Run linter
        run: cargo clippy -- -D warnings
      
      - name: Run tests
        run: cargo test --verbose

  # Python Graph Engine Tests
  graph-engine:
    name: Graph Engine (Python)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/graph-engine
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Cache pip packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pylint
      
      - name: Run linter
        run: pylint main.py || true
      
      - name: Run tests
        run: pytest --cov=. --cov-report=xml || true
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./services/graph-engine/coverage.xml
          flags: graph-engine

  # Next.js Frontend Tests
  web-dashboard:
    name: Web Dashboard (Next.js)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/web-dashboard
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: Get pnpm store directory
        id: pnpm-cache
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT
      
      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
      
      - name: Install dependencies
        run: pnpm install
      
      - name: Run linter
        run: pnpm lint || true
      
      - name: Type check
        run: pnpm tsc --noEmit || true
      
      - name: Build
        run: pnpm build
      
      - name: Run tests
        run: pnpm test || true

  # Shared Schemas Build
  shared-schemas:
    name: Shared Schemas (TypeScript)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/shared-schemas
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm install
      
      - name: Build
        run: npm run build

  # Docker Build Test
  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Test docker-compose
        run: |
          cd infra
          docker-compose config

  # All jobs passed
  all-tests-passed:
    name: All Tests Passed
    needs: [api-gateway, ingestion-worker, graph-engine, web-dashboard, shared-schemas, docker-build]
    runs-on: ubuntu-latest
    
    steps:
      - name: Success
        run: echo "âœ… All CI checks passed!"
